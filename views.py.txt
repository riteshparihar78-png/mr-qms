from rest_framework import viewsets, permissions
from rest_framework.decorators import api_view
from rest_framework.response import Response
from django.http import HttpResponse
import csv

from .models import User, ShopStrength, Coach, Inspection, Defect, Attendance, Feedback
from .serializers import (
    UserSerializer, ShopStrengthSerializer, CoachSerializer,
    InspectionSerializer, DefectSerializer, AttendanceSerializer,
    FeedbackSerializer
)

# User API
class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all()
    serializer_class = UserSerializer
    permission_classes = [permissions.IsAuthenticated]

# Shop Strength API
class ShopStrengthViewSet(viewsets.ModelViewSet):
    queryset = ShopStrength.objects.all()
    serializer_class = ShopStrengthSerializer
    permission_classes = [permissions.IsAuthenticated]

# Coach API
class CoachViewSet(viewsets.ModelViewSet):
    queryset = Coach.objects.all()
    serializer_class = CoachSerializer
    permission_classes = [permissions.IsAuthenticated]

# Inspection API
class InspectionViewSet(viewsets.ModelViewSet):
    queryset = Inspection.objects.all()
    serializer_class = InspectionSerializer
    permission_classes = [permissions.IsAuthenticated]

# Defect API
class DefectViewSet(viewsets.ModelViewSet):
    queryset = Defect.objects.all()
    serializer_class = DefectSerializer
    permission_classes = [permissions.IsAuthenticated]

# Attendance API
class AttendanceViewSet(viewsets.ModelViewSet):
    queryset = Attendance.objects.all()
    serializer_class = AttendanceSerializer
    permission_classes = [permissions.IsAuthenticated]

# Feedback API
class FeedbackViewSet(viewsets.ModelViewSet):
    queryset = Feedback.objects.all()
    serializer_class = FeedbackSerializer
    permission_classes = [permissions.IsAuthenticated]

# Backup API (download coaches as CSV)
@api_view(["GET"])
def backup_csv(request):
    response = HttpResponse(content_type="text/csv")
    response["Content-Disposition"] = 'attachment; filename="backup.csv"'
    writer = csv.writer(response)
    writer.writerow(["S.No", "Coach Type", "Coach Number", "Created At"])
    for c in Coach.objects.all():
        writer.writerow([c.sno, c.coach_type, c.coach_number, c.created_at])
    return response